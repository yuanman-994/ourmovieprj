var MovieShowtimePageClient=Class.create();Object.extend(MovieShowtimePageClient.prototype,{server:{GetMovieRatingByMovieIds:function(b,a){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","GetMovieRatingByMovieIds",[b],a,"/Cinema.api","get","60000",null)},GetShowtimeThumbStringByShowtimeId:function(b,a){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","GetShowtimeThumbStringByShowtimeId",[b],a,"/Cinema.api","get","60000",null)},GetCinemaFavorite:function(a){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","GetCinemaFavorites",[],a,"/Cinema.api","get","60000",null)},AddFavorite:function(b,a,c){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","AddCinemaFavorite",[b],a,"/Cinema.api","get","60000",c)},DelFavorite:function(b,a,c){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","DelCinemaFavorite",[b],a,"/Cinema.api","get","60000",c)},GetCinemaMoviePromotionPrice:function(b,d,c,a){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","GetCinemaMoviePromotionPrice",[b,d,c],a,"/Cinema.api","get","60000",null)},GetMovieShowTimeCountInfo:function(b,a){return Mtime.Component.Ajax.crossDomainCallBack(siteTheaterServiceUrl,"Mtime.Cinema.Services","GetMovieShowTimeCountInfoByMovieId",[b],a,"/Cinema.api","get","60000",null)},getUser:function(a){return Mtime.Component.Ajax.get("Mtime.Service.Pages.ManagerService","GetUserInfo2",[],a,"/Service/Manager.msi","get","10000")}},options:{MovieId:0},setOptions:function(a){Object.extend(Object.extend(this,this.options),a)},initialize:function(a){this.setOptions(a);this.initializeServerData();this.initializeDOM();this.initializeEvent();this.initializeControl();this.load()},initializeServerData:function(){this.isLogin=false;this.anchorCinema=false;this.locationFilterType="";this.locationFilterId=0;this.featureFilterValue=[]},initializeDOM:function(){this.movieInfoRegion=$("movieInfoRegion");this.movieRatingRegion=$("movieRatingRegion");this.hotPlayMoviesRegion=$("hotPlayMoviesRegion");this.valueDateRegion=$("valueDateRegion");this.msDatePrev=$("msDatePrev");this.msDateNext=$("msDateNext");this.featureFilterRegion=$("featureFilter");this.cinemaListRegion=$("cinemaListRegion");this.movieVideoRegion=$("movieVideoRegion");this.divRelatedGoods=$("divRelatedGoods")},destroyDOM:function(){this.movieInfoRegion=null;this.movieRatingRegion=null;this.hotPlayMoviesRegion=null;this.valueDateRegion=null;this.msDatePrev=null;this.msDateNext=null;this.cinemaListRegion=null;this.featureFilterRegion=null;this.divRelatedGoods=null},initializeEvent:function(){if(this.featureFilterRegion){this.onClickFilterRegionHandler=this.onClickFilterRegion.bind(this);Event.observe(this.featureFilterRegion,"click",this.onClickFilterRegionHandler)}this.onClickCinemaRegionHandler=this.onClickCinemaRegion.bind(this);this.cinemaListRegion&&Event.observe(this.cinemaListRegion,"click",this.onClickCinemaRegionHandler);if(Mtime.browser.ie!=0&&Mtime.browser.ie<=6){this.CinemaRegionMouseOverHandler=this.cinemaRegionMouseOver.bind(this);this.CinemaRegionMouseOutHandler=this.cinemaRegionMouseOut.bind(this);this.cinemaListRegion&&Event.observe(this.cinemaListRegion,"mouseover",this.CinemaRegionMouseOverHandler);this.cinemaListRegion&&Event.observe(this.cinemaListRegion,"mouseout",this.CinemaRegionMouseOutHandler)}Event.observe(window,"unload",this.close.bind(this))},destroyEvent:function(){if(this.featureFilterRegion){Event.stopObserving(this.featureFilterRegion,"click",this.onClickFilterRegionHandler)}if(this.cinemaListRegion){Event.stopObserving(this.cinemaListRegion,"click",this.onClickCinemaRegionHandler)}if(Mtime.browser.ie!=0&&Mtime.browser.ie<=6){Event.stopObserving(this.cinemaListRegion,"mouseover",this.CinemaRegionMouseOverHandler);Event.stopObserving(this.cinemaListRegion,"mouseout",this.CinemaRegionMouseOutHandler)}Event.stopObserving(window,"click",this.onClickWindowHandler)},initializeControl:function(){if(this.divRelatedGoods){$loadSubJs(["/Js/2014/widgets/GoodsAndFeatureCtrl.js"],function(){this.goodsAndFeatureCtrl=new GoodsAndFeatureCtrl({showRegionId:this.divRelatedGoods.id,relatedObjType:1,relatedId:this.MovieId,showCount:5,pageType:4,callback:this.initGoodsAndFeatureCtrlCallback.bind(this)})}.bind(this))}this.server.getUser(function(a){if(a&&a.value){var b=a.value;this.userCityRegion=$("userCityRegion");this.userCityListRegion=$("userCityListRegion");if(this.userCityRegion&&this.userCityListRegion){this.cityMenu=new MovieShowTimePageCityMenu({container:this.userCityRegion,cityListContainer:this.userCityListRegion,userInfo:b})}}}.bind(this));this.server.GetMovieShowTimeCountInfo(this.MovieId,function(c){if(c&&c.value){var a=c.value.cinemaCount;var d=c.value.showtimeCount;var b="今日<span>"+a+"</span>家影院，上映<span>"+d+"</span>场";$("showTimeCountRegion").update(b)}})},initGoodsAndFeatureCtrlCallback:function(){if(this.divRelatedGoods.innerHTML.length<=0){this.divRelatedGoods.hide()}else{this.divRelatedGoods.show()}},destroyControl:function(){if(this.shareCtrl){this.shareCtrl.close();this.shareCtrl=null}if(this.goodsAndFeatureCtrl){this.goodsAndFeatureCtrl.close();this.goodsAndFeatureCtrl=null}},load:function(){this.CheckUrlValid();this.GetQueryParams();this.intilizFeatureFilterRender();this.GetMovieRatingByMovieIds();this.intilizeCinemas();this.observControl()},GetQueryParams:function(){var c=location.search;if(c){var d;try{d=$H(c.parseQuery())}catch(b){d=$H()}if(d.cid){var a=Number(d.cid);if(!isNaN(a)){this.currentFilterCinemaId=a;this.anchorCinema=true}}}},CheckUrlValid:function(){var d=location.pathname.split("/").filter(function(g){return g!=""});if(d.length===4){var c=d[3];var b=Number(c.substring(4,6));var a=Number(c.substr(-2));var e=new Date();var f=e.getMonth()+1;if(f==b){if(e.getDate()-a>0){if(e.getHours()>8){d.pop();location.href=location.protocol+"//"+location.host+"/"+d.join("/")+"/"}}}else{if(f>b){if(e.getHours()>8){d.pop();location.href=location.protocol+"//"+location.host+"/"+d.join("/")+"/"}}else{}}}},intilizeCinemas:function(){this.server.GetCinemaFavorite(function(b){if(b&&b.value){if(b.value.success){this.isLogin=true;var a=b.value.favorites;if(typeof a!="undefined"&&a.length>0){this.CinemaSort(a);this.CinemaListRender()}else{this.CinemaListRender()}}else{this.CinemaListRender()}}else{this.CinemaListRender()}}.bind(this))},Render:function(){},GetMovieRatingByMovieIds:function(){var a=this.getMovieIds();if(a!=""){this.server.GetMovieRatingByMovieIds(a,function(b){if(b&&b.value&&b.value.movieratings){b.value.movieratings.each(function(c){if(c.movieid==this.MovieId){this.movieRatingRegion.innerHTML="<b>总评分</b><p>"+this.movieRatingConvert(c.rating)+"</p>";this.movieRatingRegion.show()}else{this.hotPlayMoviesRegion.getElementsBySelector("li").each(function(d){if(d.readAttribute("movieid")==c.movieid){d.down("span").innerHTML=this.movieRatingConvert(c.rating);d.down("span").show()}}.bind(this))}}.bind(this))}}.bind(this))}},movieRatingConvert:function(a){if(a*10==Math.floor(a)*10){return Math.floor(a)+".0"}else{return a+""}},getMovieIds:function(){if(this.hotPlayMoviesRegion){var a=[];this.hotPlayMoviesRegion.getElementsBySelector("li").each(function(c){var b=c.readAttribute("movieid");if(b==this.MovieId){c.hide()}a.push(b)}.bind(this));this.hotPlayMoviesRegion.show();return a.join(",")}},onClickFilterRegion:function(b){var a=Event.element(b);var c=a.readAttribute("v");if(a!==document){if(c){if(a.tagName=="I"){if(!a.hasClassName("notcheck")){if(a.hasClassName("on")){a.removeClassName("on")}else{a.addClassName("on")}}}else{if(a.tagName=="LABEL"){if(!a.previous("i").hasClassName("notcheck")){if(a.previous("i").hasClassName("on")){a.previous("i").removeClassName("on")}else{a.previous("i").addClassName("on")}}}else{return}}this.getFeatureFilterValue();this.CinemaListRender()}}},getFeatureFilterValue:function(){if(this.featureFilterRegion){this.featureFilterValue.clear();$$("#featureFilter i[v]").each(function(a){if(a.hasClassName("on")){this.featureFilterValue.push(Number(a.readAttribute("v")))}}.bind(this))}},CinemaListRender:function(){if(this.cinemaListRegion){if(typeof cinemasJson!=="undefined"&&cinemasJson.length>0){var e=false;var c=new StringBuilder();var b=0;for(var d=0;d<cinemasJson.length;d++){var a=cinemasJson[d];if(this.IsFilterPass(a)){c.append(this.CinemaItemRender(a,d));e=true;if(a.favtime>0&&d==0){b=a.cid}}}if(e){c.append('<p class="tc px14 c_666 pt25 pb30">[时光网提供的影讯仅供参考，具体情况以影院现场为准！]</p>')}this.cinemaListRegion.innerHTML=c.toString();if(b>0){this.LoadPromotionPrice(b,currentDate,this.MovieId)}}}},CinemaSort:function(c){if(typeof cinemasJson!="undefined"&&cinemasJson.length>0&&typeof c!="undefined"&&c.length>0){var e=new Date();for(var d=0;d<cinemasJson.length;d++){var a=cinemasJson[d];var b=c.find(function(f){return f.cid==a.cid});if(b){cinemasJson[d].favtime=b.entertime}else{cinemasJson[d].favtime=0}}cinemasJson.sort(function(f,g){if(f.favtime==g.favtime){if(f.sortid==g.sortid){return 0}else{if(f.sortid>g.sortid){return 1}else{return -1}}}else{return g.favtime-f.favtime}})}},CinemaItemRender:function(b,g){if(b){var j=new Date();var d=false;var h=0;var m=0;if(typeof showtimesJson!="undefined"&&showtimesJson.length>0){for(var f=0;f<showtimesJson.length;f++){var k=showtimesJson[f];if(k.cinemaId==b.cid){if(this.showtimeIsSaleChecked(k)){m++;d=true;if(m==1){h=k.mtimePrice}else{h=k.mtimePrice<h?k.mtimePrice:h}}}}}var l="";if(g==0&&b.favtime>0){l='style="display:none;"'}var e=new StringBuilder();e.append(String.format('<dl class="movieinfobox" cid="{0}">',b.cid));var a=b.favtime>0?"currstar":"";var c=b.favtime>0?"":'style="display:none;"';e.append(String.format('<dt data-selector="favregion"><a href="{0}" target="_blank">{1}</a>',b.showtimepage,b.cname));e.append(String.format('<a method="addfavorite" cid="{0}" href="#" class="ico_stat {1}" onclick="return false;">我常去</a>',b.cid,a));e.append(String.format('<a method="delfavorite" cid="{0}" href="#" class="ico_stat ico_end" onclick="return false;" {1}>取消</a>',b.cid,c));e.append("</dt>");e.append('<dd class="infotxt filmicon">');e.append(String.format("<p>{0}</p>",this.getChineseSubString(b.address,25)));e.append('<div class="moretool">');e.append(this.CinemaFeatureRender(b));e.append("</div>");e.append(this.CinemaPromotionTagRender(b));e.append(String.format('<div class="ticketselect" {0}>',l));if(d){e.append(String.format("<p><span>¥</span>{0}<span>元起</span></p>",h))}if(d){e.append(String.format('<a method="openshowtime" cid="{0}" href="#" class="ico_c_ticket" onclick="return false;">选座购票<span>∨</span></a>',b.cid))}else{e.append(String.format('<a method="openshowtime" cid="{0}" href="#" class="ico_c_ticket" onclick="return false;">查影讯<span>∨</span></a>',b.cid))}e.append("</div>");e.append("</dd>");if(b.favtime>0&&g==0){e.append('<dd class="tickettime">')}else{e.append('<dd class="tickettime" style="display:none;">')}e.append('<ul class="clearfix">');if(b.favtime>0&&g==0){e.append(this.ShowtimeRegionRender(Number(b.cid)))}e.append("</ul>");e.append('<p class="morelink"><a method="hideshowtime" cid="{0}" href="#" onclick="return false;"><b class="v_m">收起</b><span> ∧</span></a></p>');e.append("</dd>");e.append("</dl>");return e.toString()}},IsFilterPass:function(a){if(a){if(this.locationFilterType==""&&this.featureFilterValue.length<=0){return true}else{var d=false;var b=true;if(this.locationFilterType!=""&&this.locationFilterId!=0){if(this.locationFilterType=="ds"){if(this.locationFilterId==a.did){d=true}}else{if(this.locationFilterType=="bs"){if(this.ExistRelationOjbId(a.bid,this.locationFilterId)){d=true}}else{if(this.locationFilterType=="sb"){if(this.ExistRelationOjbId(a.sbid,this.locationFilterId)){d=true}}else{if(this.locationFilterType=="st"){if(this.ExistRelationOjbId(a.sid,this.locationFilterId)){d=true}}else{}}}}}else{d=true}if(this.featureFilterValue.length>0){for(var c=0;c<this.featureFilterValue.length;c++){if(a.filtervalue.indexOf(this.featureFilterValue[c])<0){b=false}}}return d&&b}}return false},ExistRelationOjbId:function(c,a){if(c==""||c=="0"||a==0){return false}var b=c.split(",");return b.include(a)},CinemaFeatureRender:function(cinema){var featureAndServices=[];if(cinema){if(cinema.feature&&cinema.feature!=""){var featureJson=eval("("+cinema.feature+")");if(featureJson.FeatureIMAX==1){featureAndServices.push(String.format('<i class="ico_c_f01" title="{0}">&nbsp;</i>',featureJson.FeatureIMAXContent))}if(featureJson.Feature3D==1){featureAndServices.push(String.format('<i class="ico_c_f02" title="{0}">&nbsp;</i>',featureJson.Feature3DContent))}if(featureJson.FeatureVIP==1){featureAndServices.push(String.format('<i class="ico_c_f03" title="{0}">&nbsp;</i>',featureJson.FeatureVIPContent))}if(featureJson.FeatureHuge==1){featureAndServices.push(String.format('<i class="ico_c_f04" title="{0}">&nbsp;</i>',featureJson.FeatureHugeContent))}if(featureJson.Feature4K==1){featureAndServices.push(String.format('<i class="ico_c_f08" title="{0}">&nbsp;</i>',featureJson.Feature4KContent))}if(featureJson.FeatureDolby==1){featureAndServices.push(String.format('<i class="ico_c_f06" title="{0}">&nbsp;</i>',featureJson.FeatureDolbyContent))}if(featureJson.Feature4D==1){featureAndServices.push(String.format('<i class="ico_c_f07" title="{0}">&nbsp;</i>',featureJson.Feature4DContent))}if(featureJson.Feature4DX==1){featureAndServices.push(String.format('<i class="ico_c_f29" title="{0}">&nbsp;</i>',featureJson.Feature4DXContent))}if(featureJson.Loveseat==1){featureAndServices.push(String.format('<i class="ico_c_f15" title="{0}">&nbsp;</i>',featureJson.LoveseatContent))}if(featureJson.HallCustomPropertyName==1){featureAndServices.push(String.format('<i class="ico_c_f28" title="{0}">&nbsp;</i>',featureJson.HallCustomPropertyContent))}if(featureJson.GlassFor3D==1){var depositDes="";switch(featureJson.GlassFor3DDeposit){case 1:depositDes="需押金";break;case 0:depositDes="免押金";break;case 2:depositDes="需购买";break}featureAndServices.push(String.format('<i class="ico_c_f09" title="{0}">&nbsp;</i>{1}',featureJson.GlassFor3DContent,depositDes))}if(featureJson.FeaturePark==1){featureAndServices.push(String.format('<i class="ico_c_f14" title="{0}">&nbsp;</i>可停车',featureJson.FeatureParkContent))}if(featureJson.SelfServiceTicket==1){featureAndServices.push(String.format('<i class="ico_c_f25" title="{0}">&nbsp;</i>取票机',featureJson.FeatureParkContent))}if(featureJson.CardPay==1){featureAndServices.push(String.format('<i class="ico_c_f12" title="{0}">&nbsp;</i>刷卡',featureJson.CardPayContent))}if(featureJson.Wifi==1){featureAndServices.push(String.format('<i class="ico_c_f13" title="{0}">&nbsp;</i>Wifi',featureJson.WIFIConent))}if(featureJson.DisabledSeat==1){featureAndServices.push(String.format('<i class="ico_c_f26" title="{0}">&nbsp;</i>无障碍',featureJson.DisabledSeatContent))}if(featureJson.IsServiceCustomProperty==1){featureAndServices.push(String.format('<i class="ico_c_f27" title="{0}">&nbsp;</i>{1}',featureJson.ServiceCustomPropertyContent,featureJson.ServiceCustomPropertyName))}}}var htmlBuilder=new StringBuilder();for(var i=0;i<Math.min(featureAndServices.length,7);i++){htmlBuilder.append(featureAndServices[i])}return htmlBuilder.toString()},CinemaPromotionTagRender:function(a){if(!a.promotions||a.promotions.length<=0){return}var c=new StringBuilder();c.append('<div class="coupbox">');for(var d=0;d<a.promotions.length;d++){var e=a.promotions[d];if(e.ActivityType==3){}var b="coup_other";if(e.ActivityType==1){b="coup_mtime"}var g="###";var f="";if(e.PCURL){g=e.PCURL;f=' target="_blank"'}if(e.SourceID==3){c.append(String.format('<div class="{0}" title="{1}"><a method="toggleAppPromTip" href="###">{2}<em>▼</em></a>',b,e.Description,e.TagName));c.append('<div class="coup_tip" style="display: none;">');c.append(String.format("<p>{0}</p>",e.Description));c.append(String.format('<p><img src="{0}" width="115" height="115"></p>',appQRcodeSrc));c.append("<p>扫一扫下载客户端</p>");c.append("</div></div> ")}else{c.append(String.format('<div class="{0}" title="{1}"><a href="{2}"{3}>{4}</a></div> ',b,e.Description,g,f,e.TagName))}}c.append("</div>");return c.toString()},GetCinemaInfoById:function(b){if(typeof cinemasJson!=="undefined"&&cinemasJson.length>0){for(var c=0;c<cinemasJson.length;c++){var a=cinemasJson[c];if(a.cid===b){return a}}}return null},ShowtimeRegionRender:function(a){if(typeof showtimesJson!=="undefined"&&showtimesJson.length>0&&a>0){var e=new Date();var b=showtimesJson.findAll(function(g){return g.cinemaId==a&&this.dateFormat(g.realtime,"yyyyMMddhhmm")>this.dateFormat(e,"yyyyMMddhhmm")}.bind(this));var c=new StringBuilder();if(b.length<=0){b=showtimesJson}for(var d=0;d<b.length;d++){var f=b[d];if(f.cinemaId!=a){continue}c.append(this.ShowtimeItemRender(f))}return c.toString()}return""},ShowtimeItemRender:function(h){if(typeof h!=="undefined"){var e=this.showtimeIsSaleChecked(h);var c=new StringBuilder();var i=h.specialTitle!=""?String.format('<b class="hotbox">{0}</b>',h.specialTitle):"";if(i==""&&h.isContinueShowtime){i=String.format('<b class="hotbox">{0}</b>',"连映场")}var d=h.isMorrowShowtime?"次日":"";var f=h.mtimePrice;var g=h.price;var a=new Template(String.format('<li class="notlink">{2}<div class="timebox fl"><p class="only">{0}<span class="nextday">{3}</span></p><p><span>#{version}</span><span>#{language}</span></p></div><div class="pricebox fl"><p class="only">{1}</p><p>参考价</p></div></li>',this.dateFormat(h.realtime,"hh:mm"),h.price!==""?"¥"+h.price:"",i,d));var j=new Template(String.format('<li class="curr"><a data-selector="buy" href="#{seatUrl}">{3}<div class="timebox fl"><p class="only">{0}<span class="nextday">{4}</span></p><p><span>#{version}</span><span>#{language}</span></p></div><div id="price_{5}" class="pricebox fl" newprice="{6}" oldprice="{7}" style="display:none;"><p class="only">{1}</p><p class="del">{2}</p></div>&nbsp;<b class="trueticket">购票</b></a></li>',this.dateFormat(h.realtime,"hh:mm"),"¥"+h.mtimePrice,h.price!==""?"¥"+h.price:"",i,d,h.showtime_ID,f,g));var b=new Template(String.format('<li>{3}<div class="timebox fl"><p class="only">{0}<span class="nextday">{4}</span></p><p><span>#{version}</span><span>#{language}</span></p></div><div class="pricebox fl"><p class="only">{1}</p><p class="del">{2}</p></div></li>',this.dateFormat(h.realtime,"hh:mm"),"¥"+h.mtimePrice,h.price!==""?"¥"+h.price:"",i,d));if(h.isSale){if(e){return j.evaluate(h).toString()}else{return b.evaluate(h).toString()}}else{return a.evaluate(h).toString()}}return""},LoadPromotionPrice:function(a,c,b){this.server.GetCinemaMoviePromotionPrice(a,c,b,function(n){$$(".pricebox").invoke("show");if(n&&n.value&&n.value.success&&n.value.priceList){for(var f=0;f<n.value.priceList.length;f++){var l=n.value.priceList[f];var o=l.ShowtimeID;if(!o||o<=0){continue}var d=$("price_"+o);if(!d){continue}var g=d.getAttribute("newprice");var j=d.getAttribute("oldprice");var m=Number(l.PromotionPrice)/100;var e=false;if(m<g){e=true;j=g;g=m}if(e){var h=h=String.format('<p class="only">¥{0}</p>',g);var k=String.format('<p class="del">¥{0}</p>',j);d.innerHTML=String.format("{0}{1}",h,k);new Insertion.Top(d.up(),'<span class="coup_sharp"></span>')}}}})},onClickCinemaRegion:function(c){var b=Event.element(c);var d=b.readAttribute("method");while(!d&&b!=document.body){b=b.up();d=b.readAttribute("method")}if(!d){return}switch(d){case"openshowtime":var a=Number(b.readAttribute("cid"));var e=b.up("dd").next("dd.tickettime");if(e){e.down("ul").innerHTML=this.ShowtimeRegionRender(a);e.show();b.up("div.ticketselect")&&b.up("div.ticketselect").hide();this.LoadPromotionPrice(a,currentDate,this.MovieId)}break;case"hideshowtime":var e=b.up("dd.tickettime");if(e){e.hide();e.up("dl.movieinfobox").down('a[method="openshowtime"]').up("div").show()}break;case"addfavorite":this.addFavorite(b);break;case"delfavorite":this.delFavorite(b);break;case"toggleAppPromTip":this.toggleAppPromTip(b);break;default:break}},addFavorite:function(c){if(typeof c!="undefined"){var a=c.next('a[method="delfavorite"]');if(typeof a=="undefined"||a.visible()){return}var b=Number(c.readAttribute("cid"));if(b>0){this.server.AddFavorite(b,function(d){if(d&&d.value){if(d.value.success){c.addClassName("currstar");a.show()}else{if(d.value.errcode=="nologin"){if(typeof UserLoginDialog!=="undefined"){new UserLoginDialog({callback:function(){location.reload()}})}else{$loadJs("/js/2014/UserLoginDialog.js",function(){new UserLoginDialog({callback:function(){location.reload()}})}.bind(this))}}else{$alert("添加收藏失败，请稍后重试")}}}else{$alert("添加收藏失败，请稍后重试")}}.bind(this),c)}}},delFavorite:function(b){if(typeof b!="undefined"){var a=Number(b.readAttribute("cid"));if(a>0){this.server.DelFavorite(a,function(c){if(c&&c.value){if(c.value.success){b.hide();if(b.previous('a[method="addfavorite"]')){b.previous('a[method="addfavorite"]').removeClassName("currstar")}}else{if(c.value.errcode=="nologin"){if(typeof UserLoginDialog!=="undefined"){new UserLoginDialog({callback:function(){location.reload()}})}else{$loadJs("/js/2014/UserLoginDialog.js",function(){new UserLoginDialog({callback:function(){location.reload()}})}.bind(this))}}else{$alert("取消收藏失败，请稍后重试")}}}else{$alert("取消收藏失败，请稍后重试")}}.bind(this),b)}}},toggleAppPromTip:function(c){if(typeof c!="undefined"){var b=c.next(".coup_tip");var a=c.down("em");if((typeof b)=="undefined"){return}if(a.innerHTML=="▼"){a.innerHTML="▲";b.show()}else{a.innerHTML="▼";b.hide()}}},showtimeIsSaleChecked:function(b){if(typeof b!="undefined"){var a=new Date();return b.isSale&&this.dateFormat(b.realtime,"yyyyMMddhhmm")>this.dateFormat(a,"yyyyMMddhhmm")}},observControl:function(){var b=0;var e=this.valueDateRegion.getElementsBySelector("li");if(typeof e!=="undefined"&&e.length>4){for(var c=0;c<e.length;c++){var d=e[c];if(d.hasClassName("curr")){b=c}}}if(this.valueDateRegion){var f=new CinemaWidgets.DistanceSlidesControl({slidesRegion:"valueDateRegion",prev:"msDatePrev",next:"msDateNext",showRegionWidth:617,slidesRegionWidth:610,currentIndex:b})}if(typeof CinemaFilterControl!="undefined"){var a=new CinemaFilterControl({clickRegion:"areaAndSubwayFilter",container:"areaAndSubwayfilterBox",districtJson:districtJson,subwayJson:subwayJson,callBack:function(g,h){this.locationFilterType=g;this.locationFilterId=h;this.CinemaListRender()}.bind(this)})}if(this.movieVideoRegion){this.movieVideoControl=new Widgets.CallOutVideo({slidesRegion:this.movieVideoRegion})}if($("inputCinameKeyword")){this.theaterFilter=new TheaterFilter({theaters:typeof cinemasJson=="undefined"?[]:cinemasJson,district:0,searchInput:"inputCinameKeyword",searchBtn:"buttonCinameKeyword",searchTip:"cinemaSearchTip",filterCallback:function(i){this.intilizFeatureFilterRender();this.locationFilterType="";this.locationFilterId=0;if($("areaAndSubwayFilter")){$("areaAndSubwayFilter").innerHTML='商圈及地铁沿线 <i class="ico_f_jiao">&nbsp;</i><em>&nbsp;</em>'}if(i&&i.length>0){var g=i[0].cid;this.CinemaListRender();var h=null;$$("#cinemaListRegion dl.movieinfobox").each(function(k){var j=Number(k.readAttribute("cid"));if(j==g){k.scrollTo();h=k}else{if(k.down("dd.tickettime").visible()){k.down("dd.tickettime").hide();k.down("div.ticketselect").show()}}}.bind(this));if(h){h.down("div.ticketselect").hide();h.down("dd.tickettime").down("ul").innerHTML=this.ShowtimeRegionRender(g);h.down("dd.tickettime").show();this.LoadPromotionPrice(g,currentDate,this.MovieId)}}}.bind(this)})}if(typeof(RightFloatToolsControl)!="undefined"&&typeof(toolBannerJson)!="undefined"){this.shareCtrl=new RightFloatToolsControl({shareRelatedObjType:1011,movieTitle:toolBannerJson.movieName,cityName:toolBannerJson.cityName,imageUrl:toolBannerJson.showtimeImageUrl,link:toolBannerJson.showtimeUrl,date:toolBannerJson.currdate,conversionUrl:toolBannerJson.conversionUrl,hasMessageButton:false,hasFavoriteButton:false})}},intilizFeatureFilterRender:function(){if(this.featureFilterRegion){if(typeof cinemasJson!="undefined"&&cinemasJson.length>0){var isTicket=false;var isPark=false;var is3D=false;var isIMAX=false;var is4DX=false;for(var i=0;i<cinemasJson.length;i++){var cinema=cinemasJson[i];var filterValue=[];if(cinema.isticket){isTicket=true;filterValue.push(1)}if(cinema.feature&&cinema.feature!=""){var feature=eval("("+cinema.feature+")");if(feature.FeaturePark=="1"){isPark=true;filterValue.push(2)}if(feature.Feature3D=="1"){is3D=true;filterValue.push(3)}if(feature.FeatureIMAX=="1"){isIMAX=true;filterValue.push(4)}if(feature.Feature4DX=="1"){is4DX=true;filterValue.push(5)}}cinemasJson[i].filtervalue=filterValue.join("")}$$("#featureFilter i[v]").each(function(item){var v=item.readAttribute("v");if(v=="1"){if(isTicket){item.removeClassName("notcheck");item.next("label").removeClassName("notcheck")}}else{if(v=="2"){if(isPark){item.removeClassName("notcheck");item.next("label").removeClassName("notcheck")}}else{if(v=="3"){if(is3D){item.removeClassName("notcheck");item.next("label").removeClassName("notcheck")}}else{if(v=="4"){if(isIMAX){item.removeClassName("notcheck");item.next("label").removeClassName("notcheck")}}else{if(v=="5"){if(is4DX){item.removeClassName("notcheck");item.next("label").removeClassName("notcheck")}}else{}}}}}item.removeClassName("on")}.bind(this))}}},showtimesRegionObserve:function(){if(this.showtimeRegion){this.showtimesRegionMouseOverHandler=this.thumbTipMouseover.bind(this);Event.observe(this.showtimeRegion,"mouseover",this.showtimesRegionMouseOverHandler);this.showtimesRegionMouseOutHandler=this.thumbTipMouseout.bind(this);Event.observe(this.showtimeRegion,"mouseout",this.showtimesRegionMouseOutHandler)}},cinemaRegionMouseOver:function(c){var d=Event.findElement(c,"dt");var e=Event.findElement(c,"a");if(d&&d!=document&&d.hasAttribute("data-selector")&&d.readAttribute("data-selector")=="favregion"){var a=d.down('a[method="addfavorite"]');var b=d.down('a[method="delfavorite"]');if(a&&!a.hasClassName("currstar")){a.style.cssText="display:inline-block;"}if(b&&a.hasClassName("currstar")){b.style.cssText="display:inline-block;"}}if(e&&e!=document&&e.hasAttribute("data-selector")&&e.readAttribute("data-selector")=="buy"){e.down("b.trueticket").style.cssText="display:block;"}},cinemaRegionMouseOut:function(c){var d=Event.findElement(c,"dt");var e=Event.findElement(c,"a");if(d&&d!=document&&d.hasAttribute("data-selector")){var a=d.down('a[method="addfavorite"]');var b=d.down('a[method="delfavorite"]');if(a&&!a.hasClassName("currstar")){a.style.cssText=""}if(b&&a.hasClassName("currstar")){b.style.cssText=""}}if(e&&e!=document&&e.hasAttribute("data-selector")&&e.readAttribute("data-selector")=="buy"){e.down("b.trueticket").style.cssText=""}},dateFormat:function(a,b){var d={"M+":a.getMonth()+1,"d+":a.getDate(),"h+":a.getHours(),"m+":a.getMinutes(),"s+":a.getSeconds(),"q+":Math.floor((a.getMonth()+3)/3),S:a.getMilliseconds()};if(/(y+)/.test(b)){b=b.replace(RegExp.$1,(a.getFullYear()+"").substr(4-RegExp.$1.length))}for(var c in d){if(new RegExp("("+c+")").test(b)){b=b.replace(RegExp.$1,RegExp.$1.length==1?d[c]:("00"+d[c]).substr((""+d[c]).length))}}return b},getChineseSubString:function(f,e){var d=0,a=f.split(""),g=[];e=e*2;var c=a.length;for(var b=0;b<c;++b){if(a[b].charCodeAt(0)<299){d+=1;if(d<=e-2){g.push(a[b])}}else{d+=2;if(d<=e-2){g.push(a[b])}}}var h=g.join("");if(h!=""&&e<d){h=h+".."}return h},close:function(){this.destroyControl();this.destroyEvent();this.destroyDOM()}});var MovieShowTimePageCityMenu=Class.create();Object.extend(MovieShowTimePageCityMenu.prototype,{server:{getData:function(a){if(typeof threaterListBoxData!=="undefined"&&threaterListBoxData.locations){a&&a()}else{$loadJs("/Utility/Data/TheaterListBoxData.m",a)}},getTheaterCityHomeURL:function(a,b){if(typeof theaterService==="undefined"){return Mtime.Component.Ajax.callBack("Mtime.Showtime.Pages.ShowtimeService","GetTheaterCityHomeURL",[a],b,"/service/showtime.ms","get","25000")}else{return Mtime.Component.Ajax.request(theaterService,"Mtime.Showtime.Pages.ShowtimeService","GetTheaterCityHomeURL",[a],b,"/service/showtime.ms","get","25000")}}},options:{userInfo:null,items:[],hotSearchItems:[290,292,293,365,974,366,561,880,791],HOTROWSIZE:10,order:"热门",container:"",cityListContainer:"",optionTS:"<li><a value=#{Id}>#{NameCn}</a></li>",content:{regRxpAG:["A","B","C","D","E","F","G"],regRxpHL:["H","I","J","K","L"],regRxpMT:["M","N","O","P","Q","R","S","T"],regRxpWZ:["U","V","W","X","Y","Z"]}},setOptions:function(a){Object.extend(Object.extend(this,this.options),a)},initialize:function(a){this.setOptions(a);this.optionTemplate=new Template(this.optionTS);this.initializeDOM();this.initializeEvent();this.getItems()},initializeDOM:function(){this.headPanel=$(this.container);this.closeNode=Builder.node("span",{className:"btn_close fr"},["关闭"]);this.contentBox=Builder.node("div");this.searchCityText=Builder.node("input",{type:"text",className:"text"});this.tab=Builder.node("span",{className:"cityletter"},[Builder.node("a",{href:"#",onclick:"return false;",className:"on",_v:"热门"},["热门",Builder.node("b",[" "])]),Builder.node("a",{href:"#",onclick:"return false;",_v:"A-G"},["A-G",Builder.node("b",[" "])]),Builder.node("a",{href:"#",onclick:"return false;",_v:"H-L"},["H-L",Builder.node("b",[" "])]),Builder.node("a",{href:"#",onclick:"return false;",_v:"M-T"},["M-T",Builder.node("b",[" "])]),Builder.node("a",{href:"#",onclick:"return false;",_v:"W-Z"},["W-Z",Builder.node("b",[" "])])]);this.span=Builder.node("span",{className:"fl w30 bold mt5"});this.bodyPanel=$(Builder.node("div",{id:"movie_showtime_tip",className:"showtime_tip",style:"display:none;width: 560px; position: absolute; top: 35px; right: 0px;"},[Builder.node("div",{className:"share_tit clearfix"},[this.closeNode,Builder.node("div",{className:"citysearch"},[this.searchCityText]),this.tab]),Builder.node("div",{className:"p15"},[this.contentBox])]));this.headPanel.appendChild(Builder.node("em"));this.headPanel.appendChild(Builder.node("label",[this.userInfo.cityName]));this.switchBtn=Builder.node("span",["[切换]"]);this.headPanel.appendChild(this.switchBtn);$(this.cityListContainer).appendChild(this.bodyPanel);var a=this.tab.childNodes;for(var b=0;b<a.length;b++){Event.observe(a[b],"click",function(f){var c=f.target||f.srcElement;if(c.innerHTML!==this.order){$A(this.tab.childNodes).each(function(e){e.className=""});c.className="on";var d=c.readAttribute("_v");this.order=d;this.reload(d)}}.bind(this))}},initializeEvent:function(){this.ononSearchCityTextFocusHandler=this.onSearchCityTextFocus.bind(this);this.onSearchCityTextBlurHandler=this.onSearchCityTextBlur.bind(this);this.onHeadPanelClickHandler=this.onHeadPanelClick.bind(this);this.onCloseHandler=this.hide.bind(this);Event.observe(this.searchCityText,"focus",this.ononSearchCityTextFocusHandler);Event.observe(this.searchCityText,"blur",this.onSearchCityTextBlurHandler);Event.observe(this.switchBtn,"click",this.onHeadPanelClickHandler);Event.observe(this.closeNode,"click",this.onCloseHandler);this.onClickPageHandler=this.onClickPage.bindAsEventListener(this);Event.observe(document.body,"click",this.onClickPageHandler)},destroyEvent:function(){this.ononSearchCityTextFocusHandler&&Event.stopObserving(this.searchCityText,"focus",this.ononSearchCityTextFocusHandler);this.onSearchCityTextBlurHandler&&Event.stopObserving(this.searchCityText,"blur",this.onSearchCityTextBlurHandler);this.onHeadPanelClickHandler&&Event.stopObserving(this.headPanel,"click",this.onHeadPanelClickHandler);this.onCloseHandler&&Event.stopObserving(this.closeNode,"click",this.onCloseHandler)},destroyPanel:function(){this.closeNode=null;this.contentBox=null;this.searchCityText=null;this.tab=null;this.span=null;this.bodyPanel=null;this.headPanel=null},close:function(){this.destroyEvent();this.destroyPanel()},onClickPage:function(a){var b=Event.pointerX(a);var c=Event.pointerY(a);if(!Position.within(this.container,b,c)&&!Position.within(this.bodyPanel,b,c)){if(this.isShowing()){this.hide();this.headPanel.removeClassName("oncity")}}},getHotItems:function(){if(!this.hotItems){this.hotItems=this.items.sortBy(function(a){return -a.OTicketCinemaCount}).slice(0,40).sortBy(function(a){return -a.VisitedTimes}).collect(function(a){return a.Id})}return this.hotItems},reload:function(e){this.contentBox.update();var a=null;switch(e){case"热门":if(!this.content.HOT){this.content.HOT=this.createOptions(this.getCitys(this.items,this.getHotItems())," ",true)}this.contentBox.update(this.content.HOT);break;case"A-G":if(!this.content.AG){a=this.items.findAll(function(f){var g=/[A-G]/.test(f.initial);return g});this.content.AG=this.makeNodes(a,this.content.regRxpAG)}this.contentBox.update(this.content.AG);break;case"H-L":if(!this.content.HL){a=this.items.findAll(function(f){var g=/[H-L]/.test(f.initial);return g});this.content.HL=this.makeNodes(a,this.content.regRxpHL)}this.contentBox.update(this.content.HL);break;case"M-T":if(!this.content.MT){a=this.items.findAll(function(f){var g=/[M-T]/.test(f.initial);return g});this.content.MT=this.makeNodes(a,this.content.regRxpMT)}this.contentBox.update(this.content.MT);break;case"W-Z":if(!this.content.WZ){a=this.items.findAll(function(f){var g=/[M-Z]/.test(f.initial);return g});this.content.WZ=this.makeNodes(a,this.content.regRxpWZ)}this.contentBox.update(this.content.WZ);break;default:break}var d=this.contentBox.getElementsByTagName("li");for(var c=0,b=d.length;c<b;c++){Event.observe(d[c],"click",function(g){var f=g.target||g.srcElement;this.command(f.getAttribute("value"))}.bind(this))}},makeNodes:function(a,c){var g=new StringBuilder();for(var d=0,b=c.length;d<b;d++){var f=c[d];var e=a.findAll(function(h){return h.initial===f}).sortBy(function(h){return -h.VisitedTimes});if(e.length>0){g.append(this.createOptions(e,f))}}return g.toString()},getItems:function(){this.locations=[];this.server.getData(function(){if(typeof threaterListBoxData!=="undefined"&&threaterListBoxData.locations){this.locations=threaterListBoxData.locations.List}this.items=[];this.locations.each(function(a){var b={Id:a.Id,NameCn:a.NameCn,NameEn:a.NameEn,initial:a.NameEn.charAt(0).toLocaleUpperCase(),PinyinShort:a.PinyinShort||"",VisitedTimes:a.VisitedTimes,OTicketCinemaCount:a.OTicketCinemaCount};this.items.push(b)}.bind(this));this.reload("热门");this.cityAutoComplete=new MovieShowTimePageCityAutoComplete({text:this.searchCityText,textWatermarkText:"直接输入城市或城市拼音",listRegion:this.contentBox,itemTemplate:'<li value="#{Id}"><span class="fl">#{NameEn}</span><span class="fr">#{NameCn}</span></li>',idFieldName:"Id",titleFieldName:"NameCn",searchDatas:this.items,defaultSearchDatas:this.getCitys(this.items,this.hotSearchItems),choiceCount:9,doCommand:this.command.bind(this),onEnterCallback:function(b){var d=this.contentBox.getElementsByTagName("li");for(var c=0,a=d.length;c<a;c++){if(d[c].className==="on"){this.command(d[c].getAttribute("value"));break}}}.bind(this)})}.bind(this))},createOptions:function(d,b,c){var e=Builder.node("div");var f=new StringBuilder();f.append('<div class="city_list2 clearfix">');f.append('<span class="fl w30 bold mt5">'+b+"</span>");f.append("<ul>");for(var a=0;a<d.length;a++){if(c&&a!==0&&(a%this.HOTROWSIZE===0)){f.append('</ul><span class="fl w30 bold mt5"> </span><ul>')}f.append(this.optionTemplate.evaluate(d[a]))}f.append("</ul>");f.append("</div>");return f.toString()},onSearchCityTextFocus:function(){$A(this.tab.childNodes).each(function(a){a.className=""})},onSearchCityTextBlur:function(a){this.order=null},onHeadPanelClick:function(a){a&&Event.stop(a);if(this.isShowing()){this.hide()}else{this.show()}},isShowing:function(){return(this.bodyPanel.style.display!="none")},show:function(){this.bodyPanel.show()},hide:function(){this.bodyPanel.hide()},command:function(a){if(a!==null){setCookie("DefaultCity-CookieKey",a);var c="http://theater."+mtimeCookieDomain+"/[^/]+";var e=["/","/cinema/","/movie/","/ecoupon/","/ticket/","/card/","/movie/\\d+/","/movie/\\d+/\\d+/","/discount/","/discount/information/","/discount/coupon/","/movie/lastday/"];var d=null;var b=e.find(function(f){var h=new RegExp(("^"+c+"("+f+")$").replace(/\//g,"\\/"));d=(location.protocol+"//"+location.host+location.pathname).match(h);if(d&&d.length==2&&f=="/movie/\\d+/\\d+/"){var g=d[1].split("/").filter(function(i){return i!=""});d[1]="/"+g[0]+"/"+g[1]+"/"}return d&&d.length==2});if(!b){location.reload()}this.server.getTheaterCityHomeURL(a,function(f){if(f&&f.value){if(b){$redirect(f.value.replace(/\/$/,"")+d[1])}else{if(callbackUrl){$redirect(callbackUrl)}else{$redirect(f.value)}}}})}},getCitys:function(f,c){var d=[];for(var e=0;e<c.length;e++){var b=c[e];var a=this.getCity(f,b);if(a!==null){d.push(a)}}if(d.length<c.length){var h=c.length-d.length;for(var g=0;g<f.length;g++){if(h===0){break}if(!c.include(f[g].Id)){d.push(f[g]);h--}}}return d},getCity:function(d,a){for(var b=0,c=d.length;b<c;b++){if(a==d[b].Id){return d[b]}}return null}});var MovieShowTimePageCityAutoComplete=Class.create();Object.extend(Object.extend(MovieShowTimePageCityAutoComplete.prototype,AutoCompleteBase.prototype),{initialize:function(a){this.baseInitialize(a)},initializeField:function(){this.firstRender=true;this.isShowMoreResult=false;this.isAutoMatchSuggest=true},initializeDOM:function(){},destroyDOM:function(){this.listTipText=null},initializeEvent:function(){},destroyEvent:function(){},baseInitializeEvent:function(){},getEntry:function(b){this.active=false;var c=this.listRegion.getElementsByTagName("li");var a=c.length;if(a>b&&b>=0){return $(c[b])}return null},onEnterText:function(){if(this.onEnterCallback){this.onEnterCallback()}},onObserverEvent:function(){var a=this.getSearchKeyword();if(a.length>=this.minChars){if(a!=this.keyword){this.keyword=a;this.render()}}else{this.keyword="";this.active=false;this.render()}},onBlurText:function(b,a){this.active=false;this.hasFocus=false;this.removeObserver()},reset:function(){this.selectedValue=null;this.index=0;this.searchIndex=0;this.entryCount=0},onClick:function(){},onClickText:function(){},onFocusText:function(a){this.hasFocus=true;this.active=true;this.render()},match:function(a,b){if((b.PinyinShort.toLowerCase().indexOf(a.toLowerCase())===0)){return true}else{if((b.NameCn.toLowerCase().indexOf(a.toLowerCase())===0)||(b.NameEn.toLowerCase().indexOf(a.toLowerCase())===0)){return true}}return false},onKeydownText:function(a){if(this.handled){this.handled=false;return}this.handled=true;switch(a.keyCode){case Event.KEY_RETURN:this.onEnterText();Event.stop(a);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();Event.stop(a);return;case Event.KEY_DOWN:this.markNext();Event.stop(a);return;default:this.addObserver();this.onChangeInput();break}},doRender:function(){if(this.isEnable){if(this.changed){this.reset()}var a=this.getSearchKeyword();if(a.length===0){this.removeObserver();this.renderDefaultList();if(Prototype.Browser.Gecko&&this.hasFocus){setTimeout(function(){var c=this.getSearchKeyword();if(c!=this.keyword){var d=this.getMoreLists();if(this.isAlwayShowList||this.entryCount>0){this.renderTip(c,this.entryCount);this.renderList(this.changed,d)}}}.bind(this),1000)}}else{var b=this.getMoreLists();if(this.isAlwayShowList||this.entryCount>0){this.renderTip(a,this.entryCount);this.renderList(this.changed,b);this.showSelectList()}else{this.hideSelectList()}}}},renderTip:function(a,b){if(this.firstRender||a===""){this.firstRender=false;this.listTipText="输入中文/拼音或按&uarr;&darr;选择"}else{if(b>0){this.listTipText=a+"，按拼音数排序"}else{this.listTipText="对不起，找不到："+a}}},renderList:function(d,g){var b='<div class="sou_window"><div class="sou_note">'+this.listTipText+'</div><div class="sou_city"><ul>'+g+"</ul></div></div>";this.listRegion.update(b);var f=this.listRegion.getElementsByTagName("li");for(var c=0,a=f.length;c<a;c++){var e=f[c];e.style.cursor="pointer";Event.observe(e,"click",function(i){var h=i.target||i.srcElement;if(h.nodeName=="SPAN"){h=h.parentNode}this.doCommand(h.getAttribute("value"))}.bind(this));Event.observe(e,"mouseover",function(i){var j=this;if(Prototype.Browser.IE){var h=i.target||i.srcElement;if(h.nodeName=="SPAN"){j=h.parentNode}else{j=h}}$A(j.parentNode.childNodes).each(function(k){k.className=""});j.className="on"});Event.observe(e,"mouseout",function(i){var j=this;if(Prototype.Browser.IE){var h=i.target||i.srcElement;if(h.nodeName=="SPAN"){j=h.parentNode}else{j=h}}j.className=""})}if(f.length>0){f[0].className="on"}}});